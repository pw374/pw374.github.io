<?xml version="1.0"?>
<feed xmlns="http://www.w3.org/2005/Atom">
 
  <title>pw374</title>
  <link href="http://pw374.github.io/"/>
  <link type="application/atom+xml" rel="self" href="http:///pw374.github.io/blog-atom.xml"/>
  <updated>2013-09-12T15:25:58+01:00</updated>
  <id>http://pw374.github.io/</id>
  <author>
    <name>Philippe Wang</name>
    <email>philippe.wang@cl.cam.ac.uk</email>
  </author>


  <entry>
    <id>http://pw374.github.io/posts/2013-09-05-21-31-26-about-omd.html</id>
    <link type="text/html" rel="alternate"
          href="http://pw374.github.io/posts/2013-09-05-21-31-26-about-omd.html"/>
    <title>OMD: a Markdown parser in OCaml</title>
    <category term='ocaml' /><category term='markdown' /><category term='software development' />    <published>2013-09-05T22:31:26+01:00</published>
    <updated>2013-09-12T15:25:58+01:00</updated>
    <author>
      <name>Philippe Wang</name>
    <uri>http://pw374.github.io/posts/2013-09-05-21-31-26-about-omd.html</uri>
    </author>
    <content type="html">
&#60;h2 id=&#34;OMDaMarkdownparserinOCaml&#34;&#62; OMD: a Markdown parser in OCaml&#60;/h2&#62;&#60;h3 id=&#34;Motivations&#34;&#62; Motivations&#60;/h3&#62;
&#60;p&#62;There  are  so many  existing  implementations  of  Markdown, why  yet
another one?   Well, after asking  the OCaml community  about existing
ways to parse and manipulate  Markdown documents, it seemed that there
were no stand-alone complete Markdown parser written in OCaml, meaning
that they  were incomplete (i.e., not fully  compatible with Markdown)
or  interfaces  to  some  Markdown  parsers  implemented  using  other
languages than OCaml.&#60;/p&#62;
&#60;p&#62;Since in OCaml  Labs we&#38;#39;re working a lot with  Github, and Github uses
Markdown a  lot (Github  web pages hosting,  Github issues,  etc.) and
other  sites are also  using Markdown  as well,  and Markdown  is very
popular and  easy to  learn, and  flexible in the  sense that  you can
always  fall back  to HTML  when you  want to  express  something that
doesn&#38;#39;t have  a special syntax in  Markdown, blah blah blah,  it was -
somehow - time to have  a Markdown parser implemented using OCaml. And
preferably  OCaml alone,  meaning that  one that  has  OCaml installed
should be able  to use it easily without having to  deal with too many
dependencies. Well, there it is: OMD!&#60;/p&#62;
&#60;h3 id=&#34;IssueswereessentiallywithMarkdownitself&#34;&#62; Issues... were essentially with Markdown itself&#60;/h3&#62;
&#60;p&#62;Every computer  scientist knows how to  write a parser  for a language
that is as simple as Markdown. Well, no, not every computer scientist,
sadly, but at least every programmer should. Ok, sadly it isn&#38;#39;t really
the case either. Anyways.&#60;/p&#62;
&#60;p&#62;Markdown is a rather simple language,  if you look at the specs. Well,
that depends on what you actuall call &#38;quot;specs&#38;quot;, of course. According to
&#60;a href=&#39;http://en.wikipedia.org/wiki/Markdow&#39;&#62;Wikipedia&#60;/a&#62;,     Markdown    was
invented by &#60;a href=&#39;http://daringfireball.net&#39;&#62;John Gruber&#60;/a&#62;, and Aaron Swartz
helped  him. Then the  original document  that describes  the Markdown
language          is          available         online          there:
&#60;a href=&#39;http://daringfireball.net/projects/markdown/syntax&#39;&#62;http://daringfireball.net/projects/markdown/syntax&#60;/a&#62;.  And you can see
that         searching        for         &#60;a href=&#39;https://www.google.com/#q=Markdown+syntax&#39;&#62;&#38;quot;Markdown+syntax&#38;quot;        on
Google&#60;/a&#62; makes that page the
top result (and here again, I&#38;#39;m kind  of helping it be and stay on the
top...).&#60;/p&#62;
&#60;p&#62;Actually, Markdown is not that  simple to parse.  Why? Because so many
things are  just left to the  imagination of the  people who implement
parsers  for  this  language,   because  programmes  can&#38;#39;t  decide  by
themselves  what&#38;#39;s right  to do.   It&#38;#39;s  really the  author(s) of  the
programme that  decides what the  programme does. And in  Markdown, so
many  things  are ambiguous  and  Gruber&#38;#39;s  document doesn&#38;#39;t  actually
describe a  grammar at all.  It just tells  you how to write  this and
that, but if you write it slightly differently, it doesn&#38;#39;t tell you
what the outcome would be. 
&#60;em&#62;&#60;strong&#62;In other words, there are no errors in Markdown.&#60;/strong&#62;&#60;/em&#62;
Every text file is a valid Markdown file, it might just be converted 
to some HTML you wouldn&#38;#39;t expect. For instance, you may write a link 
using this  syntax:&#60;/p&#62;
&#60;pre&#62;&#60;code&#62;[blah blah blah](the-url-which-can-be-absolute-or-relative)
&#60;/code&#62;&#60;/pre&#62;
&#60;p&#62;and it gets converted to&#60;/p&#62;
&#60;pre&#62;&#60;code&#62;&#38;lt;a href=&#38;quot;the-url-which-can-be-absolute-or-relative&#38;quot;&#38;gt;blah blah blah&#38;lt;/a&#38;gt;
&#60;/code&#62;&#60;/pre&#62;
&#60;p&#62;
But if you forget the closing parenthesis, then it becomes this instead&#60;/p&#62;
&#60;pre&#62;&#60;code&#62;&#38;lt;p&#38;gt;[blah blah blah](the-url-which-can-be-absolute-or-relative&#38;lt;/p&#38;gt;
&#60;/code&#62;&#60;/pre&#62;
&#60;p&#62;
precisely because nothing is wrong in Markdown.&#60;/p&#62;
&#60;p&#62;And what if there are parentheses in your URL? What if they are unbalanced?&#60;/p&#62;
&#60;h4 id=&#34;FlagrantAmbiguity&#34;&#62; Flagrant Ambiguity&#60;/h4&#62;
&#60;p&#62;The following is some text that has to mean something in Markdown...&#60;/p&#62;
&#60;pre&#62;&#60;code&#62;* Alice is falling in love with Bob.
    * Bob is secretly in love with Alice, but he&#38;#39;s seeing Eve.
  * Eve is in-between, she loves both Alice and Bob, she can&#38;#39;t help it.
&#60;/code&#62;&#60;/pre&#62;
&#60;p&#62;So, Pandoc, which a tool that converts a document in language A to a
document in language B, where A and B can be the same or different
languages amongst LaTeX, HTML, Markdown and (many) others, considers
that Eve is on the same level as Bob. So its HTML output is&#60;/p&#62;
&#60;pre&#62;&#60;code&#62;&#38;lt;ul&#38;gt;
&#38;lt;li&#38;gt;Alice is falling in love with Bob.
&#38;lt;ul&#38;gt;
&#38;lt;li&#38;gt;Bob is secretly in love with Alice, but he&#38;#39;s seeing Eve.&#38;lt;/li&#38;gt;
&#38;lt;/ul&#38;gt;&#38;lt;/li&#38;gt;
&#38;lt;li&#38;gt;Eve is in-between, she loves both Alice and Bob, she can&#38;#39;t help it.&#38;lt;/li&#38;gt;
&#38;lt;/ul&#38;gt;
&#60;/code&#62;&#60;/pre&#62;
&#60;p&#62;But if instead you add Dylan as in&#60;/p&#62;
&#60;pre&#62;&#60;code&#62;* Alice is falling in love with Bob.
   * Dylan, a new character, is being conceived here.
    * Bob is secretly in love with Alice, but he&#38;#39;s seeing Eve.
  * Eve is in-between, she loves both Alice and Bob, she can&#38;#39;t help it.
&#60;/code&#62;&#60;/pre&#62;
&#60;p&#62;then &#60;em&#62;of course&#60;/em&#62; Eve is not on the same level as Bob anymore and goes
with Dylan and Alice, Bob is on his own.&#60;/p&#62;
&#60;pre&#62;&#60;code&#62;&#38;lt;ul&#38;gt;
&#38;lt;li&#38;gt;Alice is falling in love with Bob.&#38;lt;/li&#38;gt;
&#38;lt;li&#38;gt;Dylan, a new character, is being conceived here.
&#38;lt;ul&#38;gt;
&#38;lt;li&#38;gt;Bob is secretly in love with Alice, but he&#38;#39;s seeing Eve.&#38;lt;/li&#38;gt;
&#38;lt;/ul&#38;gt;&#38;lt;/li&#38;gt;
&#38;lt;li&#38;gt;Eve is in-between, she loves both Alice and Bob, she can&#38;#39;t help it.&#38;lt;/li&#38;gt;
&#38;lt;/ul&#38;gt;
&#60;/code&#62;&#60;/pre&#62;
&#60;p&#62;This doesn&#38;#39;t make much sense...&#60;/p&#62;
&#60;p&#62;And Github&#38;#39;s embedded Markdown  to HTML converter chooses some similar
broken semantics. If one writes bullets on different levels, it shouldn&#38;#39;t
be meaningless.&#60;/p&#62;
&#60;p&#62;Also, on Github, if you write&#60;/p&#62;
&#60;pre&#62;&#60;code&#62;* 1
  * 2
    * 3
      * 4
        * 5
          * 6
            * 7
              * 8
                * 9
                  * 10
&#60;/code&#62;&#60;/pre&#62;
&#60;p&#62;Then 2 and 3 are on the same level, as for 4 and 5, 6 and 7, and 8 and 9.
1 and 10 are on their own. And if you extract 2 and 3, meaning&#60;/p&#62;
&#60;pre&#62;&#60;code&#62;  * 2
    * 3
&#60;/code&#62;&#60;/pre&#62;
&#60;p&#62;
then 2 and 3 are not on the same level anymore! 
See for yourself:&#60;/p&#62;
&#60;ul&#62;
 &#60;li&#62;raw version: &#60;a href=&#39;https://raw.github.com/pw374/sandbox/master/mad-lists.md&#39;&#62;https://raw.github.com/pw374/sandbox/master/mad-lists.md&#60;/a&#62;
 &#60;/li&#62;
 &#60;li&#62;rendered-by-Github version: &#60;a href=&#39;https://github.com/pw374/sandbox/blob/master/mad-lists.md&#39;&#62;https://github.com/pw374/sandbox/blob/master/mad-lists.md&#60;/a&#62;&#60;/li&#62;
&#60;/ul&#62;

&#60;p&#62;With OMD, hopefully, there is a deterministic meaning for each level of indentation. The list where there were Alice, Bob and Eve is converted to this to the least insane semantics I could think of.&#60;/p&#62;
&#60;p&#62;The idea  is that, since Eve  is neither on  the same level as  Bob or
Alice, Eve should be in a new list (because, obviously, she&#38;#39;s the only
one on that  level anyway). So she  is in a new list.  And since she&#38;#39;s
not on a deeper level than Bob, she shouldn&#38;#39;t be on a sub-list of his.
But  she is  on a  deeper level  than Alice,  so she  has to  be  on a
sub-list of hers. So, here is the HTML that OMD produces:&#60;/p&#62;
&#60;pre&#62;&#60;code&#62;&#38;lt;ul&#38;gt;
 &#38;lt;li&#38;gt;Alice is falling in love with Bob.
  &#38;lt;ul&#38;gt;
   &#38;lt;li&#38;gt;Bob is secretly in love with Alice, but he&#38;amp;apos;s seeing Eve.
   &#38;lt;/li&#38;gt;
  &#38;lt;/ul&#38;gt;
  &#38;lt;ul&#38;gt;
   &#38;lt;li&#38;gt;Eve is in-between, she loves both Alice and Bob, she can&#38;amp;apos;t help it.
   &#38;lt;/li&#38;gt;
  &#38;lt;/ul&#38;gt;
 &#38;lt;/li&#38;gt;
&#38;lt;/ul&#38;gt;
&#60;/code&#62;&#60;/pre&#62;
&#60;p&#62;Oh,  you might  have  noticed  that OMD  converts  quotes to  &#60;code&#62;&#38;amp;apos;&#60;/code&#62;
because otherwise I  would need to differentiate when  they have to be
converted from when it&#38;#39;s optional.&#60;/p&#62;
&#60;h3 id=&#34;Implementation&#34;&#62; Implementation&#60;/h3&#62;
&#60;p&#62;Pandoc&#38;#39;s documentation says&#60;/p&#62;
&#60;blockquote&#62;&#60;p&#62;
In contrast to most existing tools for converting markdown to HTML,
which use regex substitutions, Pandoc has a modular design: it
consists of a set of readers, which parse text in a given format and
produce a native representation of the document, and a set of writers,
which convert this native representation into a target format.
Thus, adding an input or output format requires only adding a reader
or writer.&#60;/p&#62;
&#60;/blockquote&#62;
&#60;p&#62;Come on,  most tools are using regular  expressions substitutions?!  I
can only imagine the nightmare that  it must be to implement and debug
such an implementation  -- no wait, I can&#38;#39;t because  I just don&#38;#39;t want
to imagine such a nightmare.&#60;/p&#62;
&#60;p&#62;I used functions and function calls, a lot of them are tail recursive,
not  all of  them but  then it  means  I don&#38;#39;t  need them  to be  tail
recursive, and  those functions  basically take a  list of  tokens and
return a  new list  with possibly fewer  tokens and the  expression to
which the missing ones were converted into.&#60;/p&#62;
&#60;p&#62;So far, in version 0.4 (which is  not released yet at the time I write
this), there&#38;#39;s a little less than  8k lines of pure OCaml code.  (Note
that I didn&#38;#39;t write &#38;quot;pure functional&#38;quot;, I wrote &#38;quot;pure OCaml&#38;quot;.)&#60;/p&#62;
&#60;p&#62;OMD is an  open-source free and libre software  library that any OCaml
developer can use  (hopefully quite easily since it  doesn&#38;#39;t depend on
anything else  that the standard  OCaml compiler and library).  And of
course, it&#38;#39;s also  a tool for any one who write  Markdown and wants it
to be  converted (quickly)  to HTML.  OMD, so far,  is about  10 times
faster than  Pandoc, and  I didn&#38;#39;t  even make any  efforts to  make it
fast.&#60;/p&#62;
&#60;h4 id=&#34;Compatibility&#34;&#62; Compatibility&#60;/h4&#62;
&#60;p&#62;OMD has been developed using OCaml 4.0.1, &#60;a href=&#39;https://github.com/pw374/omd/issues/19&#39;&#62;Christophe Troestler made
me make it compatible with OCaml
3.12.1&#60;/a&#62;.  Then I guess it
might work with older version of OCaml but it&#38;#39;s not certain (mainly
because OCaml&#38;#39;s standard library has slightly changed, as I think I
don&#38;#39;t use any language features that were introduced in 3.12 or 4.0).&#60;/p&#62;
&#60;p&#62;By  the way,  thank  you  Christophe for  your  support, interest  and
contributions to OMD :-)&#60;/p&#62;
&#60;h3 id=&#34;FutureofOMD&#34;&#62; Future of OMD&#60;/h3&#62;
&#60;p&#62;OMD  already is  in OPAM.   A  very stable  version of  OMD should  be
released soon.   As a  tool, it takes  Markdown as input  and produces
HTML as output.   A Markdown backend has been  freshly implemented, so
you can output  Markdown as well, which is  quite useful for debugging
or if you  want to know how many iterations you  need before you reach
the fix  point. You  can also  output &#38;quot;text&#38;quot;, in  the sense  that it&#38;#39;s
basically the HTML  without the HTML tags, so  it&#38;#39;s very non-formatted
text.  There  also are  options to output  HTML table of  contents and
parametrise their depths.&#60;/p&#62;
&#60;h3 id=&#34;OMDandOCamlorg&#34;&#62; OMD and OCaml.org&#60;/h3&#62;
&#60;p&#62;We    are    at   OCaml    Labs    making    a    new   website    for
&#60;a href=&#39;http://ocaml.org&#39;&#62;ocaml.org&#60;/a&#62;.   The  design   is  being  provided  by
&#60;a href=&#39;http://www.onespacemedia.com&#39;&#62;onespacemedia&#60;/a&#62;.    At   the  time   I&#38;#39;m
writing  these  lines, I&#38;#39;m  using  the  HTML/CSS/JS  for the  upcoming
OCaml.org to style my new Github-hosted website, so I can play with it
&#60;em&#62;more&#60;/em&#62;.&#60;/p&#62;
&#60;p&#62;Most pages will be written in Markdown instead of HTML, so that people
of the OCaml community may contribute to it in a more convenient way.&#60;/p&#62;
&#60;p&#62;And of course, that means that OMD will be used for OCaml.org.&#60;/p&#62;
&#60;p style=&#39;font-size:80%;&#39;&#62;&#60;em&#62;started on 2013-09-05 22:31:26+01:00, (re)generated on 2013-09-12 15:25:58+01:00
&#60;/em&#62;&#60;/p&#62;
</content>
  </entry>
</feed>
